<!DOCTYPE html>
<html>
<head>
    <title>任务详情</title>
    <link type="text/css" rel="stylesheet" href="/console/shared/zTree_v3/css/demo.css" />
    <link type="text/css" rel="stylesheet" href="/console/shared/zTree_v3/css/zTreeStyle/zTreeStyle.css" />
    <link type="text/css" rel="stylesheet" href="/console/datasync/css/editorLoadingCss.css" />
    <style>
        .modal-dialog{
            top:4% !important;
            width: 50% !important;
        }

        ul.ztree {
            width: 100%;
            height: 93%;
        }
        #Progress{
            left: 45% !important;
            top:  24% !important;
        }
        .circle-info{
            top:58% !important;
            line-height: 1.5 !important;
            z-index: 19891019;
        }
    </style>
</head>

<body>

<!-- 模态框（Modal） -->
<div id="dataModal" class="modal fade" tabindex="-1" data-width="400">
    <div class="modal-dialog" >
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="taskEditorTitle"></h4>
            </div>
            <div class="modal-body" style="min-height:300px;max-height:76%;overflow: auto;">
                    <!--本地数据源列表-->
                    <div id="bdsc" style="width: 90%;margin-left: 76px;">
                        <div style="" class="form-group">
                            <label>本地数据源列表:</label>
                            <select id="selectBdDirID"  class="form-control selectpicker" style="width: 200px;display: inline !important;"></select>
                            <div class="content_wrap" style="width: 89%;">
                                <label id="bdTableLabel">&nbsp;&nbsp;请选择资源</label>
                                <div id="ViewBdDirDiv" style="margin-left: 15px;overflow-y:auto;max-height: 450px;min-height: 300px;">
                                    <ul id="treeDemo" class="ztree"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                <div class="modal-footer">
                    <button type="button" onclick="submitLocalFileData()" class="btn  btn-danger">保存</button>
                    <button type="button" data-dismiss="modal" class="btn  btn-danger">取消</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div>
    <div id="Mask"></div>
    <div id="Progress" data-dimension="250" data-text="0%" data-info="导出进度" data-width="30" data-fontsize="38" data-percent="0" data-fgcolor="#61a9dc" data-bgcolor="#eee"></div>
</div>


<script type="text/javascript">

    var dataTaskId="";
    var dataSourceId="";
    var dataSourceType="";
    var dataTaskFilePath="";
    var index;
    // $.getScript("/console/shared/zTree_v3/js/jquery.ztree.excheck.js");
    // $.getScript("/console/shared/zTree_v3/js/jquery.ztree.core.js");
    $(document).ready(function(){
        $("#dataModal").modal("show");
        $.getScript("/console/datasync/js/editorLoadingJs.js");
        loadBdDataList();
      }
    );

    //加载本地数据源列表
    function loadBdDataList() {
        $.ajax({
            type:"POST",
            url:"/searchBdDirList.do",
            data:{},
            success:function (dataSession) {
                var dataSessiobArray=dataSession.replace(/\[|]/g,'').split(',');
                //  var dataSessiobArray=dataSession.substr(1,dataSession.length-4).split(',');
                $("#selectBdDirID").append("<option style='width: 300px;display: none;'>请选择...</option>");
                for(var i=0;i<dataSessiobArray.length;i++){
                    var title=dataSessiobArray[i].substr(0, dataSessiobArray[i].indexOf('?*'));
                    var uri=dataSessiobArray[i].substr(dataSessiobArray[i].indexOf('?*')+2,dataSessiobArray[i].length);
                    $("#selectBdDirID").append("<option style=width:300px; value='"+uri.replace(/[\r\n]/g,"")+"'>"+title+"</option>");
                }
                intData();//初始化
            },
            error:function () {
                console.log("请求失败")
            }
        })
    };

    //查询当前任务的基本信息-初始化
    function intData(){
        var taskId=this.document.activeElement.contentDocument.getElementById("taskIdHidden").value;
        $.ajax({
            type: "post",
            url:"/searchTaskDetailById.do",
            cache: false,
            async: false,
            data: {taskId: taskId},
            success: function(data) {
                 dataTaskId=JSON.parse(data).dataTask.dataTaskId;
                 dataSourceId=JSON.parse(data).dataTask.dataSrc.dataSourceId;
                 dataSourceType=JSON.parse(data).dataTask.dataSrc.databaseType;
                 dataTaskFilePath=JSON.parse(data).dataTask.filePath;
                $("#taskEditorTitle")[0].textContent="数据任务修改--("+JSON.parse(data).dataTask.dataTaskName+")";
                $("select option[value='"+dataSourceType+"']").attr("selected","selected");//就选中对应的option,
                 loadFileTreesByDataSource();
            },
            error: function() {
                alert("出错了");
            }
        });
    }

    //列出本地数据源中的文件树
    $("#selectBdDirID").on("change", function () {
        console.log("进入到selectBdDirID的change事件处理函数中了");
        var localDataSource = $("#selectBdDirID option:selected")[0].value;//获取数据库参数
        $.ajax({
            type:"POST",
            url:"/getTreeOfDirList.do",
            data:{
                localDataSource: localDataSource
            },
            dataType: "text",
            beforeSend:function(data){
                index = layer.load(1, {
                    shade: [0.5,'#fff'] //0.1透明度的白色背景
                });
            },
            success: function (data) {
                //console.log(data);
                $('#bdDirDiv').empty();
                $("#bdTableLabel").css("display", "block");//显示“选择资源”标签
                $("#bdSubmitButton").css("display", "block"); //显示“提交”按钮
                var coreData = JSON.parse(data).list;
                var dataTaskFilePathArray=dataTaskFilePath.split(";");
                for(var i=0;i<coreData.length;i++){
                    for(var j=0;j<dataTaskFilePathArray.length;j++){
                        if(coreData[i].id==dataTaskFilePathArray[j]){
                            coreData[i].checked=true;
                            coreData[i].open=true;
                        }
                    }
                }
                var zTreeObj = $.fn.zTree.getZTreeObj("treeDemo");
                zTreeObj.destroy();
                //$.getScript("/console/shared/zTree_v3/js/jquery.ztree.all.js",function(){
                    $.fn.zTree.init($("#treeDemo"), setting, coreData);
                    $("#layui-layer-shade"+index+"").remove();
                    $("#layui-layer"+index+"").remove();
              //  });
            },
            error: function (data) {
                console.log("获得本地目录中的文件树失败")
            }
        })
    });

    //关闭modal后隐藏锁定页面的div
    $("#dataModal").on("hide.bs.modal",function(){
        $(window.top.document.body)[0].ownerDocument.getElementById("pages").remove();
        $(window.top.document.body)[0].ownerDocument.getElementById("backdropId").remove();
    });

    function loadFileTreesByDataSource(){
        console.log("进入到selectBdDirID的change事件处理函数中了");
        var localDataSource = $("#selectBdDirID option:selected")[0].value;//获取数据數據源参数

        $.ajax({
            type:"POST",
            url:"/getEditTreeOfDirList.do",
            data:{
                localDataSource: localDataSource,
                dataTaskFilePath:dataTaskFilePath,
                dataTaskId:dataTaskId
            },
            dataType: "text",
            beforeSend:function(data){
                index = layer.load(1, {
                    shade: [0.5,'#fff'] //0.1透明度的白色背景
                });
            },
            success: function (data) {
                $('#bdDirDiv').empty();
                $("#bdTableLabel").css("display", "block");//显示“选择资源”标签
                $("#bdTableLabel").css("display", "block");//显示“选择资源”标签
                $("#bdSubmitButton").css("display", "block"); //显示“提交”按钮
                var coreData = JSON.parse(data).nodeList;
                // var dataTaskFilePathArray=dataTaskFilePath.split(";");
                // for(var i=0;i<coreData.length;i++){
                //     for(var j=0;j<dataTaskFilePathArray.length;j++){
                //         if(coreData[i].id==dataTaskFilePathArray[j]){
                //             coreData[i].checked=true;
                //             coreData[i].open=true;
                //         }
                //     }
                // }
                $.getScript("/console/shared/zTree_v3/js/jquery.ztree.all.js",function(){
                    $.fn.zTree.init($("#treeDemo"), setting, coreData);
                });
                $("#layui-layer-shade"+index+"").remove();
                $("#layui-layer"+index+"").remove();
            },
            error: function (data) {
                console.log("获得本地目录中的文件树失败")
            }
        })
    }

    var setting = {
        async: {
            enable: true,
            url:"/asyncGetNodes.do",
            autoParam:["id", "pid", "name"],
            dataFilter: filter
        },
        data: {
            simpleData: {
                enable: true,
                idKey:'id',
                pIdKey:'pid',
                rootPId: 0
            }
        },
        check: {
            enable: true
        },
        callback : {
            onAsyncSuccess: zTreeOnAsyncSuccess,//异步加载完成调用
            aOnAsyncError : zTreeOnAsyncError,//加载错误的fun
            onCheck : onCheck
        }
    };

    function filter(treeId, parentNode, childNodes) {
        childNodes=eval(childNodes);
        return childNodes;
    }

    var SubjectIndex;
    //本地文件任务提交
    function submitLocalFileData(){
        var getCheckedFile = getChecedValueInLocalTree();//获取选中的文件
        if(getCheckedFile=="" || getCheckedFile ==null){
            toastr["error"]("请选择文件！");
            return;
        }else{
            var connDataName = $("#selectBdDirID  option:selected")[0].text;//获取数据源
            var connDataValue = $("#selectBdDirID  option:selected")[0].value;//获取数据源value
            showPackProgress(0,0);
            $.ajax({
                type:"POST",
                url:"/updateLocalTaskData.do",
                timeout : 600000, //超时时间设置，单位毫秒
                data:{
                    connDataName:connDataName,
                    connDataValue:connDataValue,
                    getCheckedFile:getCheckedFile,
                    dataTaskId:dataTaskId,
                    dataSourceId:dataSourceId
                },
                success:function (dataSession) {
                    if(dataSession.replace(/[\r\n]/g,"")!="success"){
                        toastr["error"]("任务信息更新失败！");
                        // $("#layui-layer-shade"+index+"").remove();
                       //  $("#layui-layer"+index+"").remove();
                        return;
                    }else{
                        toastr["success"]("任务信息更新成功！");
                        $("#dataModal").modal('hide');
                      //   $("#layui-layer-shade"+SubjectIndex+"").remove();
                    }
                },
                error:function () {
                    console.log("请求超时！")
                }
            })
            getProcess(dataTaskId,dataTaskId+ new Date().getTime());//获取上传进度
        }
        return;
    }

    //获取界面中所有被选中的radio
    function getChecedValueInLocalTree() {
        var pathsOfCheckedFiles = '';
        var treeObj=$.fn.zTree.getZTreeObj("treeDemo"),
            nodes=treeObj.getCheckedNodes(true),v="";
        for(var i=0;i<nodes.length;i++){
            pathsOfCheckedFiles=pathsOfCheckedFiles+nodes[i].id+";";
        }
        return pathsOfCheckedFiles;
    }

    //获取上传进度
    function getProcess(keyID,souceID) {
         $("#layui-layer"+SubjectIndex+"").remove();
        var setout= setInterval(function () {
            $.ajax({
                url:"/getPackProcess.do",
                type:"POST",
                async:true,
                data:{
                    processId:keyID
                },
                success:function (dataReult) {
                    var data=dataReult.replace(/[\r\n]/g,"");
                    var process=JSON.parse(data).list[0];//上传进度
                    var fileName="";//上传文件
                    if(JSON.parse(data).list.length>=1){
                        fileName=JSON.parse(data).list[1];//上传进度
                    }
                    $("#layui-layer"+index+"").html("");
                    if(process >= 100){
                        $("#Progress .circle-text").text(process+"%");
                        $("#Progress .circle-info").text(fileName);
                        clearInterval(setout);
                        //parent.goToPage("datatask/dataTask.jsp");
                        return;
                    }
                    $("#Progress .circle-text").text(process+"%");
                    $("#Progress .circle-info").text(fileName);
                }
            })
        },1000)
    }

    var isFirstExport=true;
    //展示压缩进度
    function showPackProgress(progress,filename){
         $("#Mask").css("height",window.innerHeight);
         $("#Mask").css("width",window.innerWidth);
         $("#Mask").show();
         if(isFirstExport){
             $("#Progress").circliful();
         }else{
             $("#Progress .circle-text").text(progress+"%");
             $("#Progress .circle-info").text(filename);
             $("#Progress").show();
         }
    }

    function onCheck(event, treeId, treeNode){
        index = layer.load(1, {
            shade: [0.5,'#fff'] //0.1透明度的白色背景
        });
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
        if(treeNode.isParent){
            if (!treeNode.open){
                zTree.expandNode(treeNode, true, true, false);
                onExpand(event, treeId, treeNode);
                setTimeout(function(){
                    var children=treeNode.children;
                    for(var i=0;i<children.length;i++){
                        if(children[i].isParent ){
                            zTree.expandNode(children[i], false, false, false);
                        }
                    }
                    //zTree.expandNode(treeNode, false, false, false);
                },1000);//延时1秒
            }else{
                var children=treeNode.children;
                for(var i=0;i<children.length;i++){
                    if(children[i].isParent ){
                        if (!children[i].open){
                            zTree.expandNode(children[i], true, true, false);
                            onExpand(event, treeId, children[i]);
                        }
                    }
                }
                setTimeout(function(){
                    var children=treeNode.children;
                    for(var i=0;i<children.length;i++){
                        if(children[i].isParent ){
                            zTree.expandNode(children[i], false, false, false);
                        }
                    }
                },1000);//延时1.5秒
            }
        }
        $("#layui-layer-shade"+index+"").remove();
        $("#layui-layer"+index+"").remove();
    };

    function onExpand(event, treeId, treeNode) {
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
        var checked=treeNode.checked;
        setTimeout(function(){
            var children=treeNode.children;
            if(children!=null){
                for(var i=0;i<children.length;i++){
                    zTree.checkNode(children[i],checked,checked);
                    if(children[i].isParent){
                        if (!children[i].open){
                            zTree.expandNode(children[i], true, true, false);
                            onExpand(event, treeId, children[i]);
                            console.log(children[i]);
                            zTree.expandNode(children[i], false, false, false);
                        }
                    }
                }
            }
        },900);//延时1.2秒
    };

    //异步加载完成时运行
    function zTreeOnAsyncSuccess(event, treeId, treeNode, msg)  {

    }

    //异步加载失败
    function zTreeOnAsyncError(event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown)  {
        alertMsg.error("异步加载节点失败!");
    }

</script>
</body>

</html>