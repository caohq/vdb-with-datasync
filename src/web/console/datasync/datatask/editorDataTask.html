<!DOCTYPE html>
<html>
<head>
    <title>任务详情</title>

    <style>
     .modal-dialog{
         top:4% !important;
         width: 60% !important;
     }
    </style>
</head>

<body>
<!-- 模态框（Modal） -->
<div id="dataModal" class="modal fade" tabindex="-1" data-width="400">
    <div class="modal-dialog" >
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="taskEditorTitle"></h4>
            </div>
            <div class="modal-body" style="min-height:500px;max-height:76%;overflow: auto;">
                <!--数据库-->
                <div style="width:100%;">
                    <div id="sjk" class="form-group" style="width: 86%;margin-left: 150px;">
                        <label  >数据库列表:</label>
                        <select id="selectId" class="form-control selectpicker" style="width: 200px;display: inline !important;"></select>
                        <div>
                            <label id="tableLabel" style="margin-top: 10px">&nbsp;&nbsp;选择表资源</label>
                            <div id="tablesDiv" style="margin-left: 40px;height:260px;overflow-y:auto;"></div>
                        </div>
                        <div style="width: 100%;height: 40px;margin-top: 20px; " id="sqlSearchDiv">
                            <label>sql查询</label>
                            <input id="sqlInputBox0" class="form-control sqlStatements" style="width: 300px;display: inline !important;" type="text"/>
                            <input id="createNewTableName0" class="form-control sqlStatements" style="width: 100px;display: inline !important;" type="text" placeholder="请输入表名"/>
                            <button type="button" class="btn blue preview" onclick="showPreviewModal(sqlInputBox0)" >预览</button>
                            <button type="button" class="btn green" onclick="addSqlInput()"><span class="glyphicon glyphicon-plus"></span>sql查询</button>
                            <button type="button" class="btn green" onclick="submitSqlData()">提交</button>
                        </div>
                    </div>

                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" class="btn  btn-danger">保存</button>
                    <button type="button" data-dismiss="modal" class="btn  btn-danger">取消</button>
                </div>
            </div>
        </div>
       </div>
    </div>
</div>

<!-- 模态框（Modal）修改 -->
<div id="hiddenModal">

</div>



<input type="hidden" id="sql"/>
<input type="hidden" id="connData"/>
<input type="hidden" id="dataTaskName"/>

<script>
    var idNum=0;
    var sqlString="";//JSON.parse(data).dataTask.sqlString;
    var selectdTableNames="";//JSON.parse(data).dataTask.tableName
    var newTableNames="";//JSON.parse(data).dataTask.sqlTableNameEn
    var dataSourceValue="";//JSON.parse(data).dataTask.dataSrc.dataSourceName
    var dataTaskName="";//JSON.parse(data).dataTask.dataTaskName
    $(function(){
        $("#dataModal").modal("show");
        // $("#editorModal").modal("show");
    });
    startStep1();//启动步骤--加载数据源

    //加载数据源
    function startStep1() {
        $.ajax({
            type:"POST",
            url:"/searchDataList.do",
            cache : false,
            async: false,
            success:function (dataSession) {
                var dataSessiobArray=dataSession.replace(/\[|]/g,'').split(',');
                $("#selectId").append("<option style='width: 300px;display: none;'>请选择...</option>");
                for(var i=0;i<dataSessiobArray.length;i++){
                    $("#selectId").append("<option style=width: 300px; value='"+ dataSessiobArray[i].replace(/[\r\n]/g,"")+"'>"+ dataSessiobArray[i].substr(0, dataSessiobArray[i].indexOf('$'))+"</option>");
                }
                statrStep2();
            },
            error:function () {
                console.log("请求失败")
            }
        })
    };

    //查询当前任务的基本信息
    function statrStep2(){
        var taskId=this.document.activeElement.contentDocument.getElementById("taskIdHidden").value;
        $.ajax({
            type: "post",
            url:"/searchTaskDetailById.do",
            cache: false,
            async: false,
            data: {taskId: taskId},
            success: function(data) {
                 sqlString=JSON.parse(data).dataTask.sqlString;//任务sql语句
                 selectdTableNames=JSON.parse(data).dataTask.tableName;//选中的表名称
                 newTableNames=JSON.parse(data).dataTask.sqlTableNameEn;//新建的表名称
                 dataSourceValue=JSON.parse(data).dataTask.dataSrc.databaseType;//数据源value
                 dataTaskName=JSON.parse(data).dataTask.dataTaskName;//数据源value
                $("#taskEditorTitle")[0].textContent="数据任务修改--("+dataTaskName+")";
                $("select option[value='"+dataSourceValue+"']").attr("selected","selected");//就选中对应的option,
                 loadTablesByDataSource();
            },
            error: function() {
                alert("出错了");
            }
        });
    }

    //选中数据库，加载tables
    $("#selectId").on("change",function () {
        var connData = $("#selectId option:selected")[0].value;//获取数据库参数
        $.ajax({
            type:"POST",
            url:"/searchTables.do",
            cache: false,
            data:{
                connData:connData
            },
            success:function (data) {
                if(data.trim()=="数据库连接异常！"){
                    toastr["error"](data);
                    return;
                }
                $('#tablesDiv').empty();//清空div
                document.getElementById("tableLabel").style.display="block";//显示“选择表资源标签”
                document.getElementById("sqlSearchDiv").style.display="block";//显示“选择表资源标签”
                var obj=JSON.parse(data).tableList;
                for(var i=0;i<obj.length;i++){
                    $("#tablesDiv").append("<div style='width: 200px;float:left;'><input type='checkbox' value='"+obj[i]+"'>"+obj[i]+"</input></div>");
                }
            },
            error:function () {
                console.log("请求失败")
            }
        })
    });

    //关闭modal后隐藏锁定页面的div
    $("#dataModal").on("hide.bs.modal",function(){
        $(window.top.document.body)[0].ownerDocument.getElementById("pages").remove();
        $(window.top.document.body)[0].ownerDocument.getElementById("backdropId").remove();
        if(document.getElementsByClassName("modal-backdrop fade in")!=null){
            document.getElementsByClassName("modal-backdrop fade in")[0].remove();
        }

    });

    //添加sql语句
    function addSqlInput(){
    idNum=idNum+1;
    var divId="sqlSearchDiv"+idNum;
    var divSqlId="sqlInputBox"+idNum+"";
    $("#sjk").append("<div style=\"width: 100%;height: 40px;margin-top: 20px;margin-bottom: 20px; \" id=\""+divId+"\">\n" +
        " <label>sql查询</label>\n" +
        " <input id=\""+divSqlId+"\" class=\"form-control sqlStatements\" style=\"width: 300px;display: inline !important;\" type=\"text\"/>\n" +
        " <input id=\"createNewTableName"+idNum+"\"  class=\"form-control sqlStatements\" style=\"width: 100px;display: inline !important;\" type=\"text\" placeholder=\"请输入表名\"/>\n" +
        " <button type=\"button\" class=\"btn blue preview\" onclick=\"showPreviewModal("+divSqlId+")\" >预览</button>\n" +
        " <button type=\"button\" class=\"btn blue preview\" onclick=\"deleteSqlSearchDiv("+divId+")\" >删除</button>\n" +
        " </div>");
    };

    //删除新增的sql语句输入框
    function deleteSqlSearchDiv(idDom){
        idNum=idNum-1;
        idDom.remove();
    }

    //根据查询出的datasource加载对应的表
    function loadTablesByDataSource(){
        var connData = $("#selectId option:selected")[0].value;//获取数据库参数
        $.ajax({
            type:"POST",
            url:"/searchTables.do",
            cache: false,
            data:{
                connData:connData
            },
            success:function (data) {
                if(data.trim()=="数据库连接异常！"){
                    toastr["error"](data);
                    return;
                }
                $('#tablesDiv').empty();//清空div
                document.getElementById("tableLabel").style.display="block";//显示“选择表资源标签”
                document.getElementById("sqlSearchDiv").style.display="block";//显示“选择表资源标签”
                var obj=JSON.parse(data).tableList;
                for(var i=0;i<obj.length;i++){
                    $("#tablesDiv").append("<div style='width: 200px;float:left;'><input type='checkbox' value='"+obj[i]+"'>"+obj[i]+"</input></div>");
                }

                if(selectdTableNames!="" && selectdTableNames!=null){//任务中有选中的表
                    var selectdTableNamesArray=selectdTableNames.split(";");
                    for(var i=0;i<selectdTableNamesArray.length;i++){
                        $("input:checkBox[value="+selectdTableNamesArray[i]+"]").attr("checked","checked");
                    }
                }

                if(newTableNames!="" && newTableNames!=null){//任务中有导出SQL语句(同时必定有对应数量sql语句)
                    var newTablesArray=newTableNames.split(";");
                    var sqlStringArray=sqlString.split(";");
                    if(sqlStringArray.length-1>idNum+1){
                        for(var i=1;i<sqlStringArray.length-idNum;i++){
                            addSqlInput();
                        }
                    }

                    for(var i=0;i<sqlStringArray.length-1;i++){
                        $("#sqlInputBox"+i+"")[0].value=sqlStringArray[i];
                        $("#createNewTableName"+i+"")[0].value=newTablesArray[i];
                    }
                }
            },
            error:function () {
                console.log("请求失败")
            }
        })
    }

    //预览sql结果
    function showPreviewModal(sqlId){
        var connData = $("#selectId option:selected")[0].value;//获取数据库参数
        if(connData=="请选择..." || connData==null){
            alert("请选择数据库！");
            return;
        }
        var sql=document.getElementById(sqlId.id).value;//获取输入框中的sql语句
        if(sql=="" || sql==null){
            alert("请输入sql！");
            return;
        }
        $.ajax({
            type:"POST",
            url:"/searchDataBySql.do",
            cache: false,
            data:{
                connData:connData,
                sql:sql
            },
            success:function (data) {
                addModal();
                if(data.trim()=="sql语句错误！"){
                    toastr["error"]("SQL语句或表名错误！\n请检查sql语句及表名称是否正确");
                    // alert("SQL语句或表名错误！\n请检查sql语句及表名称是否正确");
                }else{
                    $('#editorModal').modal('show');
                    var dataArray=data.split("?*$*?");
                    if(dataArray.length>=2){
                        dataList=null;
                        columnsList=null;
                        dataList=eval(dataArray[0]);
                        columnsList=eval(dataArray[1]);
                        loadPreviewBySql(dataList,columnsList);
                    }
                }
            },
            error:function () {
                console.log("请求失败")
            }
        })
    }

    //加载sql
    function loadPreviewBySql(dataList,columnsList){//加载sql预览
        $('#table').bootstrapTable('destroy');
        $('#table').bootstrapTable({
            striped: true,
            pagination: true,
            sortable: true,
            sortOrder: "asc",
            pageNumber: 1,
            pageSize: 10,                       //每页的记录行数（*）
            //pageList: [ 25, 50, 100],
            minimumCountColumns: 5,
            search:false,
            showRefresh:false,
            uniqueId: "no",
            locale: "zh-CN",
            searchOnEnterKey:true,
            detailView: false,
            columns:columnsList
        });
        $('#table').bootstrapTable('load', dataList);
    };

    function removeModal(){
        document.getElementsByClassName("modal-backdrop fade in")[1].remove();
        $("#editorModal").remove();
    }

    function addModal(){
        $("#hiddenModal").append("<div class=\"modal fade\" id=\"editorModal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myModalLabel\" aria-hidden=\"true\" style=\"z-index:99999\">\n" +
            "    <div class=\"modal-dialog\" style=\"width: 60%;height:50%;\">\n" +
            "        <div class=\"modal-content\">\n" +
            "            <div class=\"modal-header\">\n" +
            "                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">\n" +
            "                    &times;\n" +
            "                </button>\n" +
            "                <h4 class=\"modal-title\" id=\"myModalLabel\">\n" +
            "                    表数据预览\n" +
            "                </h4>\n" +
            "            </div>\n" +
            "            <div class=\"modal-body\">\n" +
            "                <table id=\"table\" class=\"table table-bordered table-hover table-striped\" style=\"text-overflow: ellipsis;overflow: hidden;white-space: nowrap;\">\n" +
            "\n" +
            "                </table>\n" +
            "            </div>\n" +
            "            <div class=\"modal-footer\">\n" +
            "                <button type=\"button\" class=\"btn btn-default\" onclick=\"removeModal()\">关闭\n" +
            "                </button>\n" +
            "            </div>\n" +
            "        </div><!-- /.modal-content -->\n" +
            "    </div><!-- /.modal -->\n" +
            "</div>");
    }



</script>
</body>

</html>